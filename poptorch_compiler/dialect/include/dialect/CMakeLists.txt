


set(MLIR_TABLEGEN_EXE "${LLVM_TOOLS_BINARY_DIR}/${MLIR_TABLEGEN_EXE}")
set(LLVM_TABLEGEN_EXE "${LLVM_TOOLS_BINARY_DIR}/llvm-tblgen")

message(STATUS "LLVM tablegen exe ${TABLEGEN_EXE}")
message(STATUS "Using MLIR_TABLEGEN_EXE ${MLIR_TABLEGEN_EXE}")

add_mlir_interface(PoptorchInterfaces)

# This helper automatically picks up the header/tablegen files in this dir.
# However it will only look for those specific names. If we add more we will
# need to use the functions it uses internally directly.
add_mlir_dialect(Poptorch poptorch)


# After we've created the normal tablegen stuff we generate some extra headers
# to help glue everything together.


# Pure Tablegen records output as JSON.
set(LLVM_TARGET_DEFINITIONS Poptorch.td)
tablegen(LLVM Poptorch.tblgen.out --dump-json)
add_public_tablegen_target(poptorch_raw_tablegen)


add_custom_target("poptorch_decls")
add_dependencies("poptorch_decls" poptorch_raw_tablegen)

add_custom_command(TARGET "poptorch_decls"
                COMMAND python3 ${SCRIPTS_DIR}/generate_extra_headers.py
                            --input-file "${CMAKE_CURRENT_BINARY_DIR}/Poptorch.tblgen.out"
                            --interface-header-file "${CMAKE_CURRENT_BINARY_DIR}/AutogenCompiler.hpp.inc"
                            --interface-cpp-file "${CMAKE_CURRENT_BINARY_DIR}/AutogenCompiler.cpp"
                            --jit-dispatch-table-output-file "${CMAKE_CURRENT_BINARY_DIR}/JitToMlirDispatch.hpp.inc"

                # Copy decl header to source dir so it can be picked up globally.
                COMMAND ${CMAKE_COMMAND} -E copy
                            "${CMAKE_CURRENT_BINARY_DIR}/AutogenCompiler.hpp.inc"
                            "${BRIDGE_DIR}/include/pytorch_bridge/helpers/AutogenCompiler.hpp.inc"

                # And the jit binding table.
                COMMAND ${CMAKE_COMMAND} -E copy
                            "${CMAKE_CURRENT_BINARY_DIR}/JitToMlirDispatch.hpp.inc"
                            "${BRIDGE_DIR}/include/pytorch_bridge/helpers/AutogeneratedJitDispatch.hpp.inc"
                )
